<!DOCTYPE html>
<html>
  <head>
  <title></title>

	<meta charset="utf-8">
    <script type="text/javascript">
    
    var theCanvas;
    var ctx;
    var allImageData = [];
    var POSITIVE_INFINITY = 1.7976931348623157E+10308;
	function onBodyLoad()
	{		
		//document.addEventListener("deviceready", onDeviceReady, false);
      
     // ASSUMING ALL IMAGES ARE OF SAME SIZE
     
     // draw images 
     theCanvas = document.getElementById('theCanvas');
     ctx = theCanvas.getContext('2d');
     theCanvas.width = document.images.length * document.images[0].width;
     theCanvas.height = 3 * document.images[0].height;
     for(i=0;i<document.images.length;i++){
        ctx.drawImage(document.images[i],i*document.images[0].width,0);
        
        // get image data
        allImageData.push(ctx.getImageData(i*document.images[0].width,0,document.images[0].width, document.images[0].height));
     }
     
     // convert to greyscale to make things easier first
     // r*.3 g*.59 b*.11
     for(var j=0;j<allImageData.length;j++){
        for(var k=0;k<allImageData[j].data.length;k++){
            // screw the first 4 pixels
            if(k>=4){
                if(k%4==0){
                    allImageData[j].data[k] *= 0.3;
                }else if((k-1)%4==0){
                    allImageData[j].data[k] *= 0.59;
                }else if((k-2)%4==0){
                    allImageData[j].data[k] *= 0.11;
                    var sum = allImageData[j].data[k-2] + allImageData[j].data[k-1] + allImageData[j].data[k];
                    allImageData[j].data[k-2]=sum;
                    allImageData[j].data[k-1]=sum;
                    allImageData[j].data[k]=sum;
                }
            }
        }
        
     }
     
     // draw greyscale 
     for(i=0;i<allImageData.length;i++){
        ctx.putImageData(allImageData[i],i*document.images[0].width, document.images[0].height)
     }
     
     // Sum of absolute differences time
     // take small sample of one image and compare to all 
     // possible locations on target image
     // using sad, find smallest sad value out of all comparisons
     // use the smallest ssad values index to create new image
    
    var results=[];
    var numSteps = 90;
    var linearHorizStepSize = Math.floor(document.images[0].width/numSteps);
    var linearVertStepSize = document.images[0].height;
    var sampleImgSlice = sliceImage(allImageData[0],0,0,linearHorizStepSize,linearVertStepSize);
    var targetImg = allImageData[1];
    //ctx.putImageData(sampleImgSlice,0,0);
    
    var min = 0;
    var runningMin = POSITIVE_INFINITY;
    for(var j=0;j<numSteps;j++){
        results[j] = linearHorizSADImageComparison(j,numSteps,sampleImgSlice,targetImg,runningMin);
        if(results[j] < runningMin || j==1){
            min = j;
            runningMin = results[j];
        }
    }
    
    // take min slice number to rest of image width and paste that 
    // onto location of target to get resulting image
    var widthOffset = linearHorizStepSize*min;
    var remainingWidth = allImageData[0].width-widthOffset;
    var resultTargetImg = sliceImage(allImageData[1],0,0,widthOffset,linearVertStepSize);
    var resultSampleImg = sliceImage(allImageData[0],0,widthOffset,remainingWidth,linearVertStepSize);
    
    ctx.putImageData(resultTargetImg,0,resultTargetImg.height*2);
    ctx.putImageData(allImageData[0],widthOffset,resultTargetImg.height*2);
	}
    
    var linearHorizSADImageComparison = function(index, numSteps, sampleImg, targetImg, runningMin){
    
        var targetOffsetLeft = Math.floor((index/numSteps)*targetImg.width);
        var tagetOffsetTop = 0;
        var targetImgWidth = targetImg.width;
        var sampleImgWidth = sampleImg.width;
        var sampleImgHeight = sampleImg.height;
        
        var result = 0;
        for(var i=targetOffsetLeft,x=0;x<sampleImgWidth;i++,x++){
            if(result>runningMin){
                break;
            }
            for(var j=tagetOffsetTop,y=0;y<sampleImgHeight;j++,y++){
            var index = (x + y* sampleImgWidth)*4;
                result += Math.abs(sampleImg.data[index] - targetImg.data[((i+j*targetImgWidth)*4)]);
                result += Math.abs(sampleImg.data[index+1] - targetImg.data[((i+j*targetImgWidth)*4)+1]);
                result += Math.abs(sampleImg.data[index+2] - targetImg.data[((i+j*targetImgWidth)*4)+2]);
                result += Math.abs(sampleImg.data[index+3] - targetImg.data[((i+j*targetImgWidth)*4)+3]);
            }
        }        
    
        return result;
    } 
    
    var sliceImage = function(image, top, left, sliceWidth, sliceHeight){
        var slicedImage = ctx.createImageData(sliceWidth, sliceHeight);
        for(var i=left,x=0;x<sliceWidth;i++,x++){
            for(var j=top,y=0;y<sliceHeight;j++,y++){
            var index = (x + y* sliceWidth)*4;
                slicedImage.data[index] = image.data[((i+j*image.width)*4)];
                slicedImage.data[index+1] = image.data[((i+j*image.width)*4)+1];
                slicedImage.data[index+2] = image.data[((i+j*image.width)*4)+2];
                slicedImage.data[index+3] = image.data[((i+j*image.width)*4)+3];
            }
        }
        return slicedImage;
    }
/*
	function onDeviceReady()
	{

	}
   
*/

     
    </script>
  </head>
  <body onload="onBodyLoad()">      
    <canvas id="theCanvas">
        
    </canvas>
    
    <img id="img1" src="img/photo1.JPG" style="display:none" />
    <img id="img2" src="img/photo2.JPG" style="display:none" />
  </body>
</html>
