<!DOCTYPE html>
<html>
  <head>
  <title></title>

	<meta charset="utf-8">
    <script type="text/javascript" src="js/sylvester.src.js"></script>
    <script type="text/javascript">
    
    var theCanvas;
    var ctx;
    var allImageData = [];
    var POSITIVE_INFINITY = 1.7976931348623157E+10308;
	function onBodyLoad()
	{		
		//document.addEventListener("deviceready", onDeviceReady, false);
      
     // ASSUMING ALL IMAGES ARE OF SAME SIZE
     
     // draw images 
     theCanvas = document.getElementById('theCanvas');
     ctx = theCanvas.getContext('2d');
     theCanvas.width = document.images.length * document.images[0].width;
     theCanvas.height = document.images.length * document.images[0].height;
     for(i=0;i<document.images.length;i++){
        ctx.drawImage(document.images[i],i*document.images[0].width,0);
        
        // get image data
        allImageData.push(ctx.getImageData(i*document.images[0].width,0,document.images[0].width, document.images[0].height));
     }
     
     // convert to greyscale to make things easier first
     // r*.3 g*.59 b*.11
     for(var j=0;j<allImageData.length;j++){
        for(var k=0;k<allImageData[j].data.length;k++){
            if(k>=4){
                if(k%4==0){
                    allImageData[j].data[k] *= 0.3;
                }else if((k-1)%4==0){
                    allImageData[j].data[k] *= 0.59;
                }else if((k-2)%4==0){
                    allImageData[j].data[k] *= 0.11;
                    var sum = allImageData[j].data[k-2] + allImageData[j].data[k-1] + allImageData[j].data[k];
                    allImageData[j].data[k-2]=sum;
                    allImageData[j].data[k-1]=sum;
                    allImageData[j].data[k]=sum;
                }
            }
        }
        
     }
     
     // draw greyscale 
     for(i=0;i<allImageData.length;i++){
        ctx.putImageData(allImageData[i],i*document.images[0].width, document.images[0].height)
     }
     
     // Sum of absolute differences time
     // take small sample of one image and compare to all 
     // possible locations on target image
     // using sad, find smallest sad value out of all comparisons
     // use the smallest ssad values index to create new image
     
     // divide image section into grids 
     // take smaller of dimensions to get slice size
     
    //var sampleImageDim = Math.min(document.images[0].width,document.images[0].height);
    //var origImageDim = Math.max(document.images[0].width,document.images[0].height);
    
    var results=[];
    var numSteps = 10;
    var linearHorizStepSize = Math.floor(document.images[0].width/numSteps);
    var linearVertStepSize = document.images[0].height;
    var sampleImgSlice = sliceImage(allImageData[0],0,0,linearHorizStepSize,linearVertStepSize);
    var targetImg = allImageData[1];
    //ctx.putImageData(sampleImgSlice,0,0);
    
    var min = POSITIVE_INFINITY;
    for(var j=0;j<numSteps;j++){
        results[j] = linearHorizSADImageComparison(j,numSteps,sampleImgSlice,targetImg,min);
        if(results[j] < min || j==1){
            min = j;
        }
    }
    
    
    
    
    // now begin repiecing data since we know which slice is most like the target
    /*
    var cutOffset = Math.floor((min/numSteps)*origImageDim);
    var samplePiece = [];
    var origPiece = [];
    
    var rowIndex = 0;
    var colIndex = 0;
    var result = 0;
    var totalImageSize = sampleImageDim*sampleImageDim
    
    for(var k=0;k<totalImageSize;k++){
        // want to get correct row/col here
        
        if(k%sampleImageDim==0){
            rowIndex++;
            colIndex=0;
        }

        sampleValue = allImageData[0].data[rowIndex*(sampleImageDim*4)+(colIndex*4)];
        targetValue= allImageData[1].data[rowIndex*(sampleImageDim*4)+((colIndex+offset)*4)];
    */

           
	}
    
    var linearHorizSADImageComparison = function(index, numSteps, sampleImg, targetImg,currentMin){
    
        var targetOffsetLeft = Math.floor((index/numSteps)*targetImg.width);
        var tagetOffsetTop = 0;
        var targetImgWidth = targetImg.width;
        var sampleImgWidth = sampleImg.width;
        var sampleImgHeight = sampleImg.height;
        
        var result = 0;
        for(var i=targetOffsetLeft,x=0;x<sampleImgWidth;i++,x++){
            for(var j=tagetOffsetTop,y=0;y<sampleImgHeight;j++,y++){
            var index = (x + y* sampleImgWidth)*4;
                result += Math.abs(sampleImg.data[index] - targetImg.data[((i+j*targetImgWidth)*4)]);
                result += Math.abs(sampleImg.data[index+1] - targetImg.data[((i+j*targetImgWidth)*4)+1]);
                result += Math.abs(sampleImg.data[index+2] - targetImg.data[((i+j*targetImgWidth)*4)+2]);
                result += Math.abs(sampleImg.data[index+3] - targetImg.data[((i+j*targetImgWidth)*4)+3]);

            }
            if(result>currentMin){
                //break;
            }
        }        
        
        console.log('result ' + result);
        return result;
    } 
    
    var sliceImage = function(image, top, left, sliceWidth, sliceHeight){
        var slicedImage = ctx.createImageData(sliceWidth, sliceHeight);
        for(var i=left,x=0;x<sliceWidth;i++,x++){
            for(var j=top,y=0;y<sliceHeight;j++,y++){
            var index = (x + y* sliceWidth)*4;
                slicedImage.data[index] = image.data[((i+j*image.width)*4)];
                slicedImage.data[index+1] = image.data[((i+j*image.width)*4)+1];
                slicedImage.data[index+2] = image.data[((i+j*image.width)*4)+2];
                slicedImage.data[index+3] = image.data[((i+j*image.width)*4)+3];
            }
        }
        return slicedImage;
    }
/*
	function onDeviceReady()
	{

	}
   
*/

     
    </script>
  </head>
  <body onload="onBodyLoad()">      
    <canvas id="theCanvas">
        
    </canvas>
    
    <img id="img1" src="img/photo1.JPG" style="display:none" />
    <img id="img2" src="img/photo2.JPG" style="display:none" />
  </body>
</html>
